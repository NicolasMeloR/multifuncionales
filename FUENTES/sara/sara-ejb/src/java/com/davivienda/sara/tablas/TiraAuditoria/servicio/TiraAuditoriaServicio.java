/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.davivienda.sara.tablas.TiraAuditoria.servicio;

import com.davivienda.sara.base.AdministracionTablasInterface;
import com.davivienda.sara.base.BaseEntityServicio;
import com.davivienda.sara.base.exception.EntityServicioExcepcion;
import com.davivienda.sara.entitys.TiraAuditoria;
import com.davivienda.sara.tablas.edccargue.servicio.EdcCargueServicio;
import com.davivienda.utilidades.conversion.Fecha;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;
import javax.persistence.EntityManager;
import javax.persistence.ParameterMode;
import javax.persistence.Query;
import javax.persistence.StoredProcedureQuery;

/**
 *
 * @author nmelo
 */
public class TiraAuditoriaServicio{
    
     private EntityManager em;

    public TiraAuditoriaServicio(final EntityManager em) {
        this.em=em;
    }
    
    public List<TiraAuditoria> getTira(Integer codigo, Date fechaInicial, Date fechaFinal) throws EntityServicioExcepcion {
        List<TiraAuditoria> items = null;
        //items=query.getResultList();*/
        Query query = null;
        query=em.createNativeQuery(
          " SELECT "
	 +"	TA.CODIGOBANCO, "
	 +"	TA.IDZONA,  "
	 +"	TA.IDOCCA,  "
	 +"	TA.IDCAJERO, "
	 +"	TA.TIPOMAQUINA,  "
	 +"	TA.TIPOREGISTRO, "
	 +"	TA.NUMEROTRANSACCION, "
	 +"	(SELECT TA.IDTRANSACCION||'-'||DESCRIPCION "
	 +"	FROM ADMINATM.TIRA_TIPO_TRANSACCION T "
	 +"	WHERE T.CODIGO = TA.IDTRANSACCION "
	 +"	AND ESTADO = 1) IDTRANSACCION, "
	 +"	TA.TIPOTRANSACCION, "
	 +"	( SELECT M.CODIGO||'-'||M.DESCRIPCION "
	 +"  FROM  ADMINATM.TIRA_TIPO_MENSAJE M "
	 +"  WHERE M.CODIGO = TA.IDMENSAJE  "
	 +"  AND M.ESTADO = 1) DESCTRANSACCION, "
	 +"	TA.FECHAREALTRANSACCION,  "
	 +"	TA.FECHACONTABLETRANSACCION, "
	 +"	TA.NUMEROTARJETA, "
	 +"	TA.NUMEROPRODUCTO, "
	 +"	( SELECT TP.CODIGO ||'-'|| TP.DESCRIPCION "
	 +"  FROM ADMINATM.TIRA_TIPO_PRODUCTO TP "
	 +"  WHERE TP.CODIGO = TA.IDPRODUCTOORIGEN "
	 +"  AND TP.ESTADO = 1 )PTODUCTORIGEN, "
	 +"	MT.MONTOTRANSACCIONRETIRO, "
	 +"	MT.MONTOTXRETIROENTREGADO, "
	 +"	MT.VALORDONACION, "
	 +"	MT.COSTOTRANSACCION, "
	 +"	MT.VUELTASDESCRIPCION, "
	 +"	MT.MONTOTXDEPOSITO, "
	 +"	MT.MONTOTXDEPOSITORECIBIDO, "
	 +"	( SELECT REFERENCIA "
	 +"  FROM ADMINATM.TIRA_REFERENCIAS TR  "
	 +"  WHERE TR.IDCAJERO=TA.IDCAJERO  "
	 +"  AND TR.FECHAREALTRANSACCION= TA.FECHAREALTRANSACCION  "
	 +"  AND TR.NUMEROTRANSACCION = TA.NUMEROTRANSACCION "
	 +"  AND NUMREGISTRO = 1 "
	 +"	)REFERENCIA1,  "
	 +"	( SELECT REFERENCIA "
	 +"  FROM ADMINATM.TIRA_REFERENCIAS TR  "
	 +"  WHERE TR.IDCAJERO=TA.IDCAJERO  "
	 +"  AND TR.FECHAREALTRANSACCION= TA.FECHAREALTRANSACCION  "
	 +"  AND TR.NUMEROTRANSACCION = TA.NUMEROTRANSACCION "
	 +"  AND NUMREGISTRO = 2 "
	 +"	)REFERENCIA2,  "
	 +"	( SELECT REFERENCIA "
	 +"  FROM ADMINATM.TIRA_REFERENCIAS TR  "
	 +"  WHERE TR.IDCAJERO=TA.IDCAJERO  "
	 +"  AND TR.FECHAREALTRANSACCION= TA.FECHAREALTRANSACCION  "
	 +"  AND TR.NUMEROTRANSACCION = TA.NUMEROTRANSACCION "
	 +"  AND NUMREGISTRO = 3 "
	 +"	)REFERENCIA3,  "
	 +"	( SELECT TP.CODIGO ||'-'|| TP.DESCRIPCION "
	 +"  FROM ADMINATM.TIRA_TIPO_PRODUCTO TP "
	 +"  WHERE TP.CODIGO = TA.IDPRODUCTODESTINO "
	 +"  AND TP.ESTADO = 1 )PTODUCTODESTINO, "
	 +"	TA.NUMEROPRODUCTODESTINO, "
	 +"	TA.NUMEROAPROBACION, "
	 +"	TA.CODIGOERRORHOST, "
	 +"	TA.DESCRIPCIONERRORHOST, "
	 +"	TA.CODIGOERRORATM, "
	 +"	TA.DESCRIPCIONERRORATM, "
	 +"	TA.ESTADOIMPRESION, "
	 +"	TA.LOGAUDITA, "
	 +"	TI.CANTIDAD, "
	 +"	TI.VALOR, "
	 +"	TI1.CANTIDAD CANTIDAD1, "
	 +"	TI1.VALOR VALOR1, "
	 +"	TI2.CANTIDAD CANTIDAD2, "
	 +"	TI2.VALOR VALOR2, "
	 +"	TI3.CANTIDAD CANTIDAD3, "
	 +"	TI3.VALOR VALOR3, "
	 +"	TI4.CANTIDAD CANTIDAD4, "
	 +"	TI4.VALOR VALOR4, "
	 +"	TI5.CANTIDAD CANTIDAD5, "
	 +"	TI5.VALOR VALOR5, "
	 +"	TI6.CANTIDAD CANTIDAD6, "
	 +"	TI6.VALOR VALOR6, "
	 +"	TI7.CANTIDAD CANTIDAD7, "
	 +"	TI7.VALOR VALOR7, "
	 +"	TI8.CANTIDAD CANTIDAD8, "
	 +"	TI8.VALOR VALOR8, "
	 +"	TG.DENOMINACIONBILLETES,  "
	 +"	TG.CANTBILLETESPROVISION,  "
	 +"	TG.BILLETESDISPENSADOS, "
	 +"	TG.ACUMBILLETESDISPENSADOS,  "
	 +"	TG.BILLETESDEPOSITADOS, "
	 +"	TG.ACUMBILLETESDEPOSITADOS,  "
	 +"	TG.BILLETESREMANENTES, "
	 +"	TG.BILLETESRECHAZADOS, "
	 +"	TG.ACUMBILLETESRECHAZADOS,   "
	 +"	TG.BILLETESRETRAC, "
	 +"	TG.ACUMBILLETESRETRACT,  "
	 +"	TG2.DENOMINACIONBILLETES DENOMINACIONBILLETES1,  "
	 +"	TG2.CANTBILLETESPROVISION CANTBILLETESPROVISION1,  "
	 +"	TG2.BILLETESDISPENSADOS BILLETESDISPENSADOS1, "
	 +"	TG2.ACUMBILLETESDISPENSADOS ACUMBILLETESDISPENSADOS1,  "
	 +"	TG2.BILLETESDEPOSITADOS BILLETESDEPOSITADOS1, "
	 +"	TG2.ACUMBILLETESDEPOSITADOS ACUMBILLETESDEPOSITADOS1,  "
	 +"	TG2.BILLETESREMANENTES BILLETESREMANENTES1, "
	 +"	TG2.BILLETESRECHAZADOS BILLETESRECHAZADOS1, "
	 +"	TG2.ACUMBILLETESRECHAZADOS ACUMBILLETESRECHAZADOS1,   "
	 +"	TG2.BILLETESRETRAC BILLETESRETRAC1, "
	 +"	TG2.ACUMBILLETESRETRACT ACUMBILLETESRETRACT1,  "
	 +"	TG3.DENOMINACIONBILLETES DENOMINACIONBILLETES2,  "
	 +"	TG3.CANTBILLETESPROVISION CANTBILLETESPROVISION2,  "
	 +"	TG3.BILLETESDISPENSADOS BILLETESDISPENSADOS2, "
	 +"	TG3.ACUMBILLETESDISPENSADOS ACUMBILLETESDISPENSADOS2,  "
	 +"	TG3.BILLETESDEPOSITADOS BILLETESDEPOSITADOS2, "
	 +"	TG3.ACUMBILLETESDEPOSITADOS ACUMBILLETESDEPOSITADOS2,  "
	 +"	TG3.BILLETESREMANENTES BILLETESREMANENTES2, "
	 +"	TG3.BILLETESRECHAZADOS BILLETESRECHAZADOS2, "
	 +"	TG3.ACUMBILLETESRECHAZADOS ACUMBILLETESRECHAZADOS2,   "
	 +"	TG3.BILLETESRETRAC BILLETESRETRAC2, "
	 +"	TG3.ACUMBILLETESRETRACT ACUMBILLETESRETRACT2,  "
	 +"	TG4.DENOMINACIONBILLETES DENOMINACIONBILLETES3,  "
	 +"	TG4.CANTBILLETESPROVISION CANTBILLETESPROVISION3,  "
	 +"	TG4.BILLETESDISPENSADOS BILLETESDISPENSADOS3, "
	 +"	TG4.ACUMBILLETESDISPENSADOS ACUMBILLETESDISPENSADOS3,  "
	 +"	TG4.BILLETESDEPOSITADOS BILLETESDEPOSITADOS3, "
	 +"	TG4.ACUMBILLETESDEPOSITADOS ACUMBILLETESDEPOSITADOS3,  "
	 +"	TG4.BILLETESREMANENTES BILLETESREMANENTES3, "
	 +"	TG4.BILLETESRECHAZADOS BILLETESRECHAZADOS3, "
	 +"	TG4.ACUMBILLETESRECHAZADOS ACUMBILLETESRECHAZADOS3,   "
	 +"	TG4.BILLETESRETRAC BILLETESRETRAC3, "
	 +"	TG4.ACUMBILLETESRETRACT ACUMBILLETESRETRACT3,  "
	 +"	TG5.DENOMINACIONBILLETES DENOMINACIONBILLETES4,  "
	 +"	TG5.CANTBILLETESPROVISION CANTBILLETESPROVISION4,  "
	 +"	TG5.BILLETESDISPENSADOS BILLETESDISPENSADOS4, "
	 +"	TG5.ACUMBILLETESDISPENSADOS ACUMBILLETESDISPENSADOS4,  "
	 +"	TG5.BILLETESDEPOSITADOS BILLETESDEPOSITADOS4, "
	 +"	TG5.ACUMBILLETESDEPOSITADOS ACUMBILLETESDEPOSITADOS4,  "
	 +"	TG5.BILLETESREMANENTES BILLETESREMANENTES4, "
	 +"	TG5.BILLETESRECHAZADOS BILLETESRECHAZADOS4, "
	 +"	TG5.ACUMBILLETESRECHAZADOS ACUMBILLETESRECHAZADOS4,   "
	 +"	TG5.BILLETESRETRAC BILLETESRETRAC4, "
	 +"	TG5.ACUMBILLETESRETRACT ACUMBILLETESRETRACT4,  "
	 +"	TG6.DENOMINACIONBILLETES DENOMINACIONBILLETES5,  "
	 +"	TG6.CANTBILLETESPROVISION CANTBILLETESPROVISION5,  "
	 +"	TG6.BILLETESDISPENSADOS BILLETESDISPENSADOS5, "
	 +"	TG6.ACUMBILLETESDISPENSADOS ACUMBILLETESDISPENSADOS5,  "
	 +"	TG6.BILLETESDEPOSITADOS BILLETESDEPOSITADOS5, "
	 +"	TG6.ACUMBILLETESDEPOSITADOS ACUMBILLETESDEPOSITADOS5,  "
	 +"	TG6.BILLETESREMANENTES BILLETESREMANENTES5, "
	 +"	TG6.BILLETESRECHAZADOS BILLETESRECHAZADOS5, "
	 +"	TG6.ACUMBILLETESRECHAZADOS ACUMBILLETESRECHAZADOS5,   "
	 +"	TG6.BILLETESRETRAC BILLETESRETRAC5, "
	 +"	TG6.ACUMBILLETESRETRACT ACUMBILLETESRETRACT5 "
	 +"FROM ADMINATM.TIRA_AUDITORIA TA "
	 +"JOIN TIRA_MONTO_TRANSACCION MT "
	 +"ON MT.IDCAJERO =  TA.IDCAJERO "
	 +"AND MT.FECHAREALTRANSACCION =  TA.FECHAREALTRANSACCION "
	 +"AND MT.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG "
	 +"ON  TG.IDCAJERO = TA.IDCAJERO "
	 +"AND TG.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG.NUMEROGAVETA = 1 "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG2 "
	 +"ON  TG2.IDCAJERO = TA.IDCAJERO "
	 +"AND TG2.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG2.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG2.NUMEROGAVETA = 2 "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG3 "
	 +"ON  TG3.IDCAJERO = TA.IDCAJERO "
	 +"AND TG3.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG3.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG3.NUMEROGAVETA = 3 "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG4 "
	 +"ON  TG4.IDCAJERO = TA.IDCAJERO "
	 +"AND TG4.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG4.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG4.NUMEROGAVETA = 4 "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG5 "
	 +"ON  TG5.IDCAJERO = TA.IDCAJERO "
	 +"AND TG5.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG5.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG5.NUMEROGAVETA = 5 "
	 +"JOIN ADMINATM.TIRA_GAVETAS TG6 "
	 +"ON  TG6.IDCAJERO = TA.IDCAJERO "
	 +"AND TG6.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TG6.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TG6.NUMEROGAVETA = 6 "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI "
	 +"ON  TI.IDCAJERO = TA.IDCAJERO "
	 +"AND TI.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI.CODIGOMOVIMIENTO = 'RETDAV'  "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI1 "
	 +"ON  TI1.IDCAJERO = TA.IDCAJERO "
	 +"AND TI1.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI1.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI1.CODIGOMOVIMIENTO = 'AVADAV' "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI2 "
	 +"ON  TI2.IDCAJERO = TA.IDCAJERO "
	 +"AND TI2.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI2.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI2.CODIGOMOVIMIENTO = 'AVAOTR' "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI3 "
	 +"ON  TI3.IDCAJERO = TA.IDCAJERO "
	 +"AND TI3.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI3.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI3.CODIGOMOVIMIENTO = 'RETCIB'  "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI4 "
	 +"ON  TI4.IDCAJERO = TA.IDCAJERO "
	 +"AND TI4.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI4.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI4.CODIGOMOVIMIENTO = 'RETGIR' "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI5 "
	 +"ON  TI5.IDCAJERO = TA.IDCAJERO "
	 +"AND TI5.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI5.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI5.CODIGOMOVIMIENTO = 'DEPAHO' "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI6 "
	 +"ON  TI6.IDCAJERO = TA.IDCAJERO "
	 +"AND TI6.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI6.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI6.CODIGOMOVIMIENTO = 'DEPCOR'  "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI7 "
	 +"ON  TI7.IDCAJERO = TA.IDCAJERO "
	 +"AND TI7.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI7.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI7.CODIGOMOVIMIENTO = 'DEPDAV'  "
	 +"JOIN ADMINATM.TIRA_TOTAL_TRANSACCION TI8 "
	 +"ON  TI8.IDCAJERO = TA.IDCAJERO "
	 +"AND TI8.FECHAREALTRANSACCION = TA.FECHAREALTRANSACCION "
	 +"AND TI8.NUMEROTRANSACCION =  TA.NUMEROTRANSACCION "
	 +"AND TI8.CODIGOMOVIMIENTO = 'DEPOTR' "
	 +"WHERE TA.FECHAREALTRANSACCION BETWEEN  ?2 AND  ?3 "//TO_DATE('15/03/2020','DD/MM/YYYY') "
	 +" AND TA.IDCAJERO = (CASE WHEN -1=?1 THEN TA.IDCAJERO " 
         +"    ELSE ?1 END ) "
	 +"ORDER BY TA.IDCAJERO, TA.FECHAREALTRANSACCION DESC ", TiraAuditoria.class);
        query.setParameter(1, codigo);
        query.setParameter(2, fechaInicial);
        query.setParameter(3, fechaFinal);
        items=query.getResultList();
        //query.executeUpdate();
        if(items!=null){
                return items;
        }else{
                return null;
        }
    }
}
